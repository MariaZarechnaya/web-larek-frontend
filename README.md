# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Схема структуры приложения
![Схема структуры приложения](./схема%20для%20документации.png)
## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```
## Данные и типы данных, используемых в приложении. 

 Данные одной карточки:
 ```
export interface ICard {
    id: string,
    category: string;
    title: string;
    description:string;
    image:string;
    price:number | null;

}
``` 



Данные пользователя, используемые для оформления заказа:
```
export  interface IUser {
    payment: string;
    address:string;
    email:string;
    phone:string;
    items:string[]
    total: number
    
}
``` 
Формы
``` 
export interface IOrderForm {
    payment?: string;
    email: string;
    phone: string;
    address:string
}
``` 
Ошибки
``` 
export type FormErrors = Partial<Record<keyof IOrderForm, string>>;
``` 
Коллекция карточек: 
```
export  interface ICardList  {
    total:number;
    cards: ICard[]  
    preview: string | null 
}
``` 
Сумма заказа для окна успешного подтверждения
```
interface ISuccess {
    total: number;
}
```


## Архитектура приложения
Приложение написано на базе архитектуры MVP. MVP разделяет приложение на три основных компонента:
1. Модель (Model): Модель представляет собой бизнес-логику приложения и данные. Она ответственна за выполнение операций, таких как чтение и запись данных, обработка бизнес-логики и взаимодействие с базой данных или внешними источниками данных.
2. Представление (View): Представление отображает данные пользователю и обрабатывает пользовательский ввод. Оно представляет собой интерфейс пользователя, через который пользователь взаимодействует с приложением.
3. Презентер (Presenter): Презентер является посредником между моделью и представлением. Он содержит бизнес-логику приложения и управляет взаимодействием между моделью и представлением. Презентер получает данные от модели, форматирует их и передает представлению для отображения. Он также обрабатывает пользовательский ввод, передавая соответствующие команды модели для обновления данных.


## Базовый код
### Класс EventEmitter

Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий. \
\
 Класс имеет методы:
* `on` - подписка
*  `off` - отписка
*  `emit`  —  уведомления подписчиков о наступлении события соответственно.Инициализация событий
Дополнительно реализованы методы  onAll и  offAll  — для подписки на все события и сброса всех
подписчиков.
Интересным дополнением является метод  trigger , генерирующий заданное событие с заданными
аргументами. Это позволяет передавать его в качестве обработчика события в другие классы. 
### Класс API
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Поля:
- baseUrl: string - ссылка для запроса
- options: RequestInit - опции, передаваемые в параметры запроса
Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

## Cлой данных
### класс AppState
Класс отвечает за хранение и логику работы с данными приложения. 

В полях класса хранятся следующие данные:

-  basket: CardItem[] = [] - коллекция карточек в корзине
- basketTotal: number - сумма
- catalog: CardItem[] - каталог товаров на странице
- preview: string; - данные для превью
- formErrors: FormErrors = {}; - объект ошибок

объект заказа
- order: IUser = {\
 payment: '',\
 email: '',\
 phone: '',\
address:'',\
total: 0,\
items: []\
    };



Класс так же содержит методы:

- getCard (id:string):ICard- возвращает карточку по ее id
- setCatalog(items: ICard[]) - устанавливает каталог
- setBasket(item: CardItem) - устанавливает данные корзины
- clearBasket() - очистка корзины
- clearItems () - очистка товаров в заказе
- setItems(item:ICard) - наполнить заказ товарами
- getBasket () - получить данные корзины
- checkCard (id:string) - проверка карточки
- setPreview(item: CardItem) - установка превью
- removeFromBasket (id:string) - убрать даннные из корзины
- getTotal() - получить сумму
- getBasketNumber() - получить количество товаро в ворзине
- setOrderField(field: keyof IOrderForm, value: string) - заполнить поля заказа
- validateOrder()  - валидация

 

## Представление
### Базовый Класс Component
Класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Содержит метод render, отвечающий за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.

### Класс Modal
Реализует модальное окно. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.\
\
Интерфейс, описывающий объект с разметкой для вставки в модальное окно
```
interface IModalData {
    content: HTMLElement;
}
```
Поля класса:
- content: HTMLElement - контейнер для вставки
- events: IEvents - брокер событий 
- closeButton: HTMLButtonElement - кнопка закрытия
- render(data: IModalData): HTMLElement - метод будет возвращать элемент модального окну с установленной разметкой
- сеттер set content(value: HTMLElement) - для установки контента 

Конструктор:
- constructor(container: HTMLElement events: IEvents) -  принимает элемент  модального окна и экземпляр класса `EventEmitter` для возможности инициации событий.

Методы класса:
- open():void - метод для открытия модального окна
- close():void  - метод для закрытия модального окна. Так же обнуляет разметку и удаляет обработчики событий с разметки через this.content = null
- handleEsc(event):void  - закрытие по кнопке esc
- render():HTMLElement - отрисовка разметки для модального окна
- сеттер set content - вставляет контент в контейнер модального окна

### Класс Card
Отвечает за отображение карточки, задавая в карточке данные названия товара, категории, изображения, стоимости, описания товара. Класс используется для отображения карточек на странице сайта. В конструктор класса передается DOM элемент темплейта. В классе устанавливаются слушатели на все интерактивные элементы, в результате взаимодействия с которыми пользователя генерируются соответствующие события.\

Интерфейс событий
```
interface ICardActions {
    onClick?: (event: MouseEvent) => void;
}
```

Поля класса содержат элементы разметки элементов карточки. Конструктор, кроме темплейта принимает экземпляр `EventEmitter` для инициации событий.
    protected _title: HTMLElement;
    protected _category: HTMLElement;
    protected _image?: HTMLImageElement;
    protected _description?: HTMLElement;
    protected _price: HTMLElement;
    protected _button?: HTMLButtonElement;
Поля:
   - category: HTMLElement - отображение категории
   - title: HTMLElement - название
   - description: HTMLElement - описание
   - image:HTMLDivElement - картинка
  -  price:HTMLElement -  стоимость
  - button: HTMLButtonElement; - кнопка

   Конструктор:
- constructor(blockName: string, container: HTMLElement, actions?: ICardActions) -  принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для возможности инициации событий.
   
Методы:
- сеттеры и геттеры для наполнения
- changeButton() - измененеие отображения кнопки


### Класс BasketCard
Отвечает за отображение списка товаров, добавленных в корзину

Поля класса:
   - title: HTMLElement; - элемент заголовка
   - price: HTMLElement; - цена
   -  button: HTMLButtonElement; - элемент кнопки
   - listNumber: HTMLElement; - контейнер для вывода номера в списке

Конструктор:
- constructor( blockName: string, container: HTMLElement, actions?: ICardActions)- в конструктор принимает контейнер, куда выводится список товаров

Методы:

- сеттеры для заполнения элементов разметки корзины 


### Класс Form
Является родительским классом для всех форм в приложении. Содержит общие методы для форм. Наследуется от Component

Интерфейс состояния формы:
```
interface IFormState {
    valid: boolean;
    errors: string[];
}
```

Поля класса:
- submit: HTMLButtonElement - кнопка сабмита
- errors: HTMLElement - поля с ошибками

Конструктор:
- constructor(container: HTMLFormElement,  events: IEvents) 
Методы:
- onInputChange(field: keyof T, value: string) - реакция на события инпутов формы
- set valid(value: boolean) - устанавливает валидность формы
- set errors(value: string)  - устанавливает ошибки
- render(state: Partial<T> & IFormState) - возвращает элемент формы с наполнением

### Класс Order
Наследуется от класса Form. Управляет отображением различных вариантов форм на странице

Поля класса:
- btnCollection :  HTMLElement[] - коллекция собственных кнопок, отвечающих за выбор оплаты

Конструктор:
- constructor(container: HTMLFormElement, events: IEvents)

### Класс Page
Отвечает за отрисовку страницы
```
interface IPage {
    counter: number; 
    catalog: HTMLElement[]; 
}
```
Поля класса:
- counter: HTMLElement; - количество товара в корзине
- catalog: HTMLElement; - массив разметок карточки
 - wrapper: HTMLElement; - общий контейнер страницы
- basket: HTMLElement; - элемент корзины

Методы:
- сеттеры и геттеры для наполнения 
- set locked () - сеттер отвечает за установку блокировки страницы

### Класс Success
Класс, отвечающий за окно успешного подтверждения заказа.
```
interface ISuccess {
    total: number;
}
```
Поля класса:

- close: HTMLElement - кнопка закрытия

Конструктор:
- constructor(container: HTMLElement, actions: IEvent) - принимает в кончтруктор элемент разметки и брокер событий

Методы:
- set total(total: number) - установка значения суммы 

## Слой коммуникации

### Класс LarekApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.
Методы: 
-  getCardList(): Promise<ICard[]> - возвращает массив данных карточек 
- getCardItem(id: string): Promise<ICard> - запрос данных одной карточки
- orderLots(order: IUser): Promise<IOrderResult> - отправка данных заказа

### Взаимодействие компонентов

Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в index.ts
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.
Так же в файле инициированы шаблоны разметки

*Список всех событий:*
- `card:select` - усчтановить карточку для превью
- `basket:delete-carditems:changed` - удалить из корзины
- `basket:change` - изменение корзины
- `preview:changed` - открыть превью
- `basket:open` - открыть корзину
- `order:open` - открыть форму заказа
- `contacts:open` - открыть форму заказа с контактными данными
- `/^order\..*:change/` - отслеживание изменения формы 
- `/^contacts\..*:change/` - отслеживание изменения формы 
- `payment:change` - усановить тип оплаты
- `contacts:submit` - отправка формы
- `formErrors:change` - показ ошибок
- `modal:open` - открыть модальное окно 
- `modal:close` - закрыть модальное окно 

